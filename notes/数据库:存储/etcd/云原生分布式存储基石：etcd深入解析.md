# \#第一部分：基础篇

# 第一章：分布式系统与一致性协议

## 1、CAP 原理







## 2、一致性

### (1) 一致性模型







### (2) 一致性模型分述







### (3) 复制状态机







### (4) 拜占庭将军问题







### (5) FLP 不可能性







## 3、Paxos 协议









## 4、Raft 协议

### (1) Raft 一致性算法







### (2) 可用性与时序







### (3) 异常情况







### (4) 日志压缩与快照







### (5) Raft 算法性能评估









# \# 第二部分：实战篇

# 第二章：为什么使用 etcd

## 1、etcd 简介







## 2、etcd 架构

### (1) etcd 数据通道







### (2) etcd 架构







## 3、etcd 典型应用场景

### (1) 服务注册与发现







### (2) 消息发布和订阅







### (3) 负载均衡







### (4) 分布式通知与协调







### (5) 分布式锁







### (6) 分布式队列







### (7) 集群监控与 Leader 竞选







## 4、etcd 性能测试

### (1) etcd 读性能







### (2) etcd 写性能







## 5、etcd 与其他键值存储系统的对比

### (1) ZooKeeper VS etvd





### (2) Consul VS etcd







### (3) NewSQL(Cloud Spanner、CockroachDB、TiDB) VS etcd







### (4) 使用 etcd 做分布式协同









## 6、使用 etcd 的项目







## 7、etcd 概念词汇表







## 8、etcd 发展里程碑

### (1) etcd 0.4 版本









### (2) etcd 2.0 版本









### (3) etcd 3.0 版本











# 第三章：etcd 初体验

## 1、单机部署

### (1) 单实例 etcd





### (2) 多实例 etcd







## 2、多节点集群化部署

### (1) 静态配置







### (2) 服务发现







## 3、etcdctl 常用命令行

### (1) key 的常规操作







### (2) key 的历史与 watch







### (3) 租约







## 4、etcd 常用配置参数

### (1) member 相关参数项





### (2) cluster 相关参数项





### (3) proxy 相关参数项





### (4) 安全相关参数项





### (5) 日志相关参数项





### (6) 不安全参数项





### (7) 统计相关参数项





### (8) 认证相关参数项







# 第四章：etcd 开放 API 之 v2

## 1、API 保证









## 2、etcd v2 API

### (1) 集群管理 API







### (2) 键值 API







### (3) 健的 TTL







### (4) 等待变化通知：watch







### (5) 自动创建有序 key







### (6) 目录 TTL







### (7) 原子的 CAS







### (8) 原子的 CAD







### (9) 创建目录







### (10) 罗列目录







### (11) 删除目录







### (12) 获取一个隐藏节点







### (13) 通过文件设置 key







### (14) 线性读









## 3、统计数据

### (1) Leader 数据







### (2) 节点自身的数据







### (3) 更多统计数据









## 4、member API

### (1) List member







### (2) 加入一个 member







### (3) 删除一个 member







### (4) 修改 member 的 peer URL









# 第五章：etcd 开放 API 之 v3

## 1、从 v2 到 v3

### (1) gRPC







### (2) 序列化和反序列化优化







### (3) 减少 TCP 连接







### (4) 租约机制







### (5) etcd v3 的观察者模式







### (6) etcd v3 的数据存储模型







### (7) etcd v3 的迷你事务







### (8) 快照







### (9) 大规模 watch







## 2、gRPC 服务







## 3、请求和响应







## 4、KV API

### (1) 键值对







### (2) revision







### (3) 键区间







### (4) Range API







### (5) PUT 调用







### (6) 事务







### (7) Compact 调用









## 5、watch API

### (1) Event







### (2) 流式 watch







## 6、Lease API

### (1) 获得租约





### (2) Keep Alives







## 7、API 使用示例









# 第六章：etcd 集群运维与稳定性

## 1、etcd 升级

### (1) 从 v2.3 升级到 v3.0





### (2) 从 v3.0 升级到 v3.1







## 2、从 v2 切换到 v3

### (1) 切换客户端代码





### (2) 数据迁移







## 3、运行时重配置

### (1) 两阶段配置更新保证集群安全





### (2) 永久性失去半数以上 member







## 4、参数调优

### (1) 时间参数





### (2) 快照







### (3) 磁盘







### (4) 网络







## 5、监控







## 6、维护

### (1) 压缩历史版本







### (2) 消除碎片化







### (3) 存储配额







### (4) 快照备份







## 7、灾难恢复

### (1) 快照







### (2) 恢复集群









## 8、etcd 网关

### (1) 何时使用 etcd 网关







### (2) 启动 etcd 网关









## 9、gRPC 代理

### (1) 可扩展的 watch API





### (2) 限制







### (3) 可扩展的带租约的 API







### (4) 服务端保护







### (5) 启动 gRPC 代理







### (6) 客户端节点同步和域名解析







### (7) 名字空间







## 10、故障恢复

### (1) 小部分从节点故障







### (2) 主节点故障







### (3) 大部分节点故障







### (4) 网络分区







### (5) 集群启动异常





## 11、硬件







# 第七章：etcd 安全

## 1、访问安全

### (1) 权限资源







### (2) 键值资源







### (3) 配置资源







## 2、etcd 访问控制实践

### (1) User 相关命令







### (2) Role 相关命令







### (3) 启用用户权限功能









## 3、传输安全

### (1) TLS/SSL 工作原理







### (2) 使用 TLS 加密 etcd 通信







### (3) etcd 安全配置详解









# \# 第三部分：高级篇

# 第八章：多版本并发控制

## 1、MVCC







## 2、etcd v2 存储机制







## 3、etcd v3 数据模型

### (1) 逻辑视图





### (2) 物理视图







## 4、etcd v3 的 MVCC 实现







## 5、etcd v3 的 MVCC 源码分析

### (1) revision





### (2) key 到 revision 间的映射关系







### (3) 从 BoltDB 中读取 key 的 value 值







### (4) 压缩历史版本







## 6、底层存储引擎：BoltDB









# 第九章：etcd 的日志和快照管理

## 1、数据持久化和复制







## 2、etcd 的日志管理

### (1) WAL 数据结构







### (2) WAL 文件物理格式







### (3) WAL 文件的初始化







### (4) WAL 追加日志项







### (5) WAL 日志回放







### (6) Master 向 Slave 推送日志







### (7) Follower 日志追加









## 3、etcd v2 的快照管理

### (1) 快照数据结构







### (2) 创建快照







### (3) 快照复制







### (4) 快照之后的日志回收









# 第十章：etcd v3 的事务和隔离

## 1、事务 ACID







## 2、事务的隔离性

### (1) Read uncommitted(读未提交)







### (2) Read committed(读提交)









### (3) Repeatable read(重复读)









## 3、etcd 的事务

### (1) Serializability 的重要性







### (2) etcd v3 的事务实现







### (3) 软件事务内存







### (4) etcd v3 STM 实现











# 第十一章：etcd watch 机制详解

## 1、v2 的 watch 机制详解

### (1) 客户端的 watch 请求





### (2) key 发生变更时通知客户端







### (3) 带版本号的 watch







### (4) v2 watch 的限制







## 2、v3 的 watch 实现机制





